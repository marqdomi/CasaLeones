{# ═══════════════════════════════════════════
   Data Table Component
   Usage:
     {% from 'components/_data_table.html' import data_table %}
     {% call(row) data_table(
         items=productos,
         columns=[
           ('Nombre', 'nombre', true),
           ('Precio', 'precio', true),
           ('Categoría', none, false)
         ],
         empty_text='No hay productos',
         empty_icon='package',
         search_placeholder='Buscar producto…',
         id='tblProductos'
     ) %}
       <td>{{ row.nombre }}</td>
       <td>${{ '%.2f'|format(row.precio) }}</td>
       <td>{{ row.categoria.nombre if row.categoria else '—' }}</td>
     {% endcall %}
   ═══════════════════════════════════════════ #}

{% macro data_table(
    items,
    columns,
    empty_text='Sin resultados',
    empty_icon='inbox',
    search_placeholder='Buscar…',
    show_search=true,
    id='dataTable',
    striped=true,
    hoverable=true,
    responsive=true,
    class_extra=''
) %}
<div class="cl-table__toolbar" id="{{ id }}_toolbar">
  {% if show_search %}
  <div class="cl-table__search">
    <i data-lucide="search" class="icon-sm"></i>
    <input type="search"
           class="cl-form-input"
           placeholder="{{ search_placeholder }}"
           aria-label="{{ search_placeholder }}"
           data-table-search="{{ id }}"
           autocomplete="off">
  </div>
  {% endif %}
</div>

{% if responsive %}<div class="table-responsive">{% endif %}
<table class="cl-table{% if striped %} cl-table--striped{% endif %}{% if hoverable %} cl-table--hover{% endif %} {{ class_extra }}"
       id="{{ id }}">
  <thead>
    <tr>
      {% for label, field, sortable in columns %}
      <th{% if sortable %} class="cl-table__sortable" data-sort="{{ field }}" tabindex="0" role="columnheader" aria-sort="none"{% endif %}>
        {{ label }}
        {% if sortable %}<i data-lucide="arrow-up-down" class="icon-xs" style="opacity:.4"></i>{% endif %}
      </th>
      {% endfor %}
    </tr>
  </thead>
  <tbody>
    {% if items %}
      {% for row in items %}
      <tr data-id="{{ row.id if row.id is defined else loop.index }}">
        {{ caller(row) }}
      </tr>
      {% endfor %}
    {% else %}
      <tr>
        <td colspan="{{ columns|length + (1 if show_actions else 0) }}">
          <div class="cl-empty-state" style="padding:var(--cl-space-10) 0">
            <i data-lucide="{{ empty_icon }}" class="cl-empty-state__icon"></i>
            <p class="cl-empty-state__text">{{ empty_text }}</p>
          </div>
        </td>
      </tr>
    {% endif %}
  </tbody>
</table>
{% if responsive %}</div>{% endif %}

{# Client-side search filtering + keyboard sort #}
<script>
(function(){
  const input = document.querySelector('[data-table-search="{{ id }}"]');
  if(!input) return;
  const table = document.getElementById('{{ id }}');
  if(!table) return;
  input.addEventListener('input', function(){
    const q = this.value.toLowerCase();
    table.querySelectorAll('tbody tr').forEach(function(tr){
      tr.style.display = tr.textContent.toLowerCase().includes(q) ? '' : 'none';
    });
  });
  // Keyboard activation for sortable headers (Enter / Space)
  table.querySelectorAll('.cl-table__sortable').forEach(function(th){
    th.addEventListener('keydown', function(e){
      if(e.key === 'Enter' || e.key === ' '){ e.preventDefault(); th.click(); }
    });
  });
})();
</script>
{% endmacro %}
