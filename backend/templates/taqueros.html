{% extends "base.html" %}
{% block title %}Órdenes - Estación Taqueros{% endblock %}

{% block content %}
{% set total_productos = ordenes_por_estacion.values() | map('length') | sum %}
<div class="container mt-4">
  <h2 class="mb-4 text-center">Órdenes para Taqueros</h2>
  <div id="pendingCount" class="alert alert-info text-center">
    Total de productos pendientes: <span id="contador-productos-pendientes">{{ total_productos }}</span>
  </div>

  {% if total_productos > 0 %}
  <div class="row" id="ordenes-pendientes-lista">
    {% for orden_id, detalles in ordenes_por_estacion.items() if detalles|length > 0 %}
      <div class="col-md-6 mb-4 orden-card" id="orden-{{ orden_id }}">
        <div class="card shadow-sm">
          <div class="card-header text-white {% if detalles[0].orden.es_para_llevar %}bg-success{% else %}bg-primary{% endif %}">
            Orden #{{ orden_id }} &ndash; {{ detalles|length }} productos
            <span class="badge ms-2 {% if detalles[0].orden.es_para_llevar %}bg-light text-dark{% else %}bg-warning text-dark{% endif %}">
              {{ detalles[0].orden.es_para_llevar and 'Para Llevar' or 'Para Mesa' }}
            </span>
          </div>
          <ul class="list-group list-group-flush">
            {% for group in detalles|groupby('producto.nombre') %}
            <li class="list-group-item d-flex justify-content-between align-items-center producto-item" id="item-{{ group.list[0].id }}">
                <span>{{ group.grouper }} &ndash; {{ group.list|length }}</span>
                <button class="btn btn-sm btn-success marcar-listo-btn"
                        data-detalle-id="{{ group.list[0].id }}" data-orden-id="{{ group.list[0].orden_id }}">
                  ✓ Listo
                </button>
              </li>
            {% endfor %}
          </ul>
        </div>
      </div>
    {% endfor %}
  </div>
  {% else %}
    <p class="text-center">No hay órdenes pendientes para Taqueros.</p>
  {% endif %}
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.5/socket.io.js" integrity="sha512-luMnTJZ7oEchNDZAtQhgjomP1eZefnl82ruTH/3Oj/Yu5qYtwL7+dVRccACS/Snp1lFXq188XFipHKYE75IaQQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
$(document).ready(function() {
    var socket = io.connect(location.protocol + '//' + document.domain + ':' + location.port);

    socket.on('connect', function() {
        console.log('Conectado al servidor de WebSockets! (Taquero)');
    });

    socket.on('disconnect', function() {
        console.log('Desconectado del servidor de WebSockets. (Taquero)');
    });

    function cargarOrdenesPendientes() {
        let fragmentUrl = "/cocina/taquero/fragmento_ordenes";
        console.log(`Recibido evento, actualizando órdenes para Taquero desde ${fragmentUrl}...`);
        $.ajax({
            url: fragmentUrl,
            type: 'GET',
            dataType: 'json',
            success: function(response) {
                $('#ordenes-pendientes-lista').html(response.html);
                $('#contador-productos-pendientes').text(response.conteo_productos);
                console.log('Lista de órdenes y contador actualizados para Taqueros.');
            },
            error: function(xhr, status, error) {
                console.error("Error al actualizar la lista de órdenes de Taquero:", error);
            }
        });
    }

    socket.on('nueva_orden_cocina', function(data) {
        console.log('Evento nueva_orden_cocina recibido en Taquero:', data);
        cargarOrdenesPendientes();
    });

    socket.on('item_listo_notificacion', function(data) {
        console.log('Evento item_listo_notificacion recibido en Taquero:', data);
        cargarOrdenesPendientes();
    });

    $('#ordenes-pendientes-lista').on('click', '.marcar-listo-btn', function() {
        var detalleId = $(this).data('detalle-id');
        var ordenId = $(this).data('orden-id');
        if (!detalleId || !ordenId) {
            console.error("Error: detalleId u ordenId no fueron encontrados en los atributos data- del botón.");
            alert("Error al obtener datos del ítem. Por favor, recargue la página e intente de nuevo.");
            return;
        }
        console.log(`Intentando marcar como listo: ordenId=${ordenId}, detalleId=${detalleId} para la estación de Taqueros`);
        $.ajax({
            url: '/cocina/taqueros/marcar/' + ordenId + '/' + detalleId,
            type: 'POST',
            success: function(response) {
                if (response && (response.message === 'Producto marcado como listo' || response.success)) {
                    console.log('Respuesta AJAX exitosa para detalleId: ' + detalleId + '. El ítem fue marcado como listo en el backend. Esperando actualización de UI vía Socket.IO.');
                } else {
                    let mensajeError = 'Error desconocido al marcar como listo.';
                    if (response && (response.message || response.mensaje)) {
                        mensajeError = response.message || response.mensaje;
                    }
                    alert('Error al marcar como listo: ' + mensajeError);
                    console.error('Error en respuesta del servidor (success false o formato inesperado):', response);
                }
            },
            error: function(xhr, status, error) {
                console.error("Error en la petición AJAX para marcar como listo en Taqueros:", status, error, xhr.responseText);
                alert('Error de comunicación con el servidor al intentar marcar como listo. Por favor, revise la consola para más detalles.');
            }
        });
    });
});
</script>
{% endblock %}