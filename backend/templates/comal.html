{% block scripts %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.5/socket.io.js" integrity="sha512-luMnTJZ7oEchNDZAtQhgjomP1eZefnl82ruTH/3Oj/Yu5qYtwL7+dVRccACS/Snp1lFXq188XFipHKYE75IaQQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script>
$(document).ready(function() {
    var socket = io.connect(location.protocol + '//' + document.domain + ':' + location.port);

    socket.on('connect', function() {
        console.log('Conectado al servidor de WebSockets! (Comal)');
    });

    socket.on('disconnect', function() {
        console.log('Desconectado del servidor de WebSockets. (Comal)');
    });

    function cargarOrdenesPendientes() {
        let fragmentUrl = "/cocina/comal/fragmento_ordenes"; // Específico para comal
        console.log(`Recibido evento, actualizando órdenes para Comal desde ${fragmentUrl}...`);
        $.ajax({
            url: fragmentUrl,
            type: 'GET',
            success: function(newHtml) {
                $('#ordenes-pendientes-lista').html(newHtml);
                console.log('Lista de órdenes de Comal actualizada.');
            },
            error: function(xhr, status, error) {
                console.error("Error al actualizar la lista de órdenes de Comal:", error);
            }
        });
    }

    socket.on('nueva_orden_cocina', function(data) {
        console.log('Evento nueva_orden_cocina recibido en Comal:', data);
        cargarOrdenesPendientes();
    });

    socket.on('item_listo_notificacion', function(data) {
        console.log('Evento item_listo_notificacion recibido en Comal:', data);
        cargarOrdenesPendientes();
    });

    $('#ordenes-pendientes-lista').on('click', '.marcar-listo-btn', function() {
        var detalleId = $(this).data('detalle-id');
        var ordenId = $(this).data('orden-id');
        if (!detalleId || !ordenId) {
            console.error("Error: detalleId u ordenId no fueron encontrados en los atributos data- del botón.");
            alert("Error al obtener datos del ítem. Por favor, recargue la página e intente de nuevo.");
            return;
        }
        console.log(`Intentando marcar como listo: ordenId=${ordenId}, detalleId=${detalleId} para la estación de Comal`);
        $.ajax({
            url: '/cocina/comal/marcar/' + ordenId + '/' + detalleId,
            type: 'POST',
            success: function(response) {
                if (response && (response.message === 'Producto marcado como listo' || response.success)) {
                    console.log('Respuesta AJAX exitosa para detalleId: ' + detalleId + '. El ítem fue marcado como listo en el backend. Esperando actualización de UI vía Socket.IO.');
                } else {
                    let mensajeError = 'Error desconocido al marcar como listo.';
                    if (response && (response.message || response.mensaje)) {
                        mensajeError = response.message || response.mensaje;
                    }
                    alert('Error al marcar como listo: ' + mensajeError);
                    console.error('Error en respuesta del servidor (success false o formato inesperado):', response);
                }
            },
            error: function(xhr, status, error) {
                console.error("Error en la petición AJAX para marcar como listo en Comal:", status, error, xhr.responseText);
                alert('Error de comunicación con el servidor al intentar marcar como listo. Por favor, revise la consola para más detalles.');
            }
        });
    });
});
</script>
{% endblock %}
