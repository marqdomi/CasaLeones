{% extends 'base.html' %}
{% block title %}Órdenes Delivery{% endblock %}
{% block content %}
<div class="container-fluid">
  <h2 class="mt-4">Órdenes de Delivery</h2>
  <p class="text-muted">Órdenes recibidas de plataformas externas (Uber Eats, Rappi, DiDi Food).</p>

  {% if ordenes %}
  <div class="table-responsive">
    <table class="table table-striped table-sm">
      <thead>
        <tr><th>Plataforma</th><th>ID Ext.</th><th>Orden Int.</th><th>Cliente</th><th>Dirección</th><th>Total Plat.</th><th>Comisión</th><th>Estado</th><th>Recibido</th><th>Acciones</th></tr>
      </thead>
      <tbody>
        {% for d in ordenes %}
        <tr>
          <td>
            <span class="badge {% if d.plataforma == 'uber_eats' %}bg-dark{% elif d.plataforma == 'rappi' %}bg-warning text-dark{% else %}bg-info{% endif %}">
              {{ d.plataforma }}
            </span>
          </td>
          <td><small>{{ d.external_id }}</small></td>
          <td>{{ '#' ~ d.orden_id if d.orden_id else '—' }}</td>
          <td>{{ d.cliente_nombre or '—' }}</td>
          <td><small>{{ d.direccion_entrega or '—' }}</small></td>
          <td>${{ '%.2f'|format(d.total_plataforma or 0) }}</td>
          <td>${{ '%.2f'|format(d.comision or 0) }}</td>
          <td>
            <span class="badge {% if d.estado_plataforma == 'aceptada' %}bg-primary{% elif d.estado_plataforma == 'lista_para_recoger' %}bg-success{% elif d.estado_plataforma == 'nueva' %}bg-warning text-dark{% else %}bg-secondary{% endif %}">
              {{ d.estado_plataforma }}
            </span>
          </td>
          <td>{{ d.fecha_recibido.strftime('%H:%M') if d.fecha_recibido else '' }}</td>
          <td>
            {% if d.estado_plataforma in ('nueva', None) %}
            <button class="btn btn-sm btn-primary btn-aceptar-delivery" data-id="{{ d.id }}">Aceptar</button>
            {% elif d.estado_plataforma == 'aceptada' %}
            <button class="btn btn-sm btn-success btn-listo-delivery" data-id="{{ d.id }}">Listo</button>
            {% endif %}
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <script>
  document.addEventListener('DOMContentLoaded', function() {
      document.querySelectorAll('.btn-aceptar-delivery').forEach(btn => {
          btn.addEventListener('click', async function() {
              const id = this.dataset.id;
              await fetch(`/delivery/admin/${id}/aceptar`, { method: 'POST' });
              location.reload();
          });
      });
      document.querySelectorAll('.btn-listo-delivery').forEach(btn => {
          btn.addEventListener('click', async function() {
              const id = this.dataset.id;
              await fetch(`/delivery/admin/${id}/listo`, { method: 'POST' });
              location.reload();
          });
      });
  });
  </script>
  {% else %}
  <div class="alert alert-info">No hay órdenes de delivery.</div>
  {% endif %}

  <div class="card mt-4">
    <div class="card-header">Configuración de Webhooks</div>
    <div class="card-body">
      <p>Configura estos endpoints en tus plataformas de delivery:</p>
      <ul class="list-unstyled">
        <li><strong>Uber Eats:</strong> <code>POST {{ request.host_url }}delivery/webhook/uber_eats</code></li>
        <li><strong>Rappi:</strong> <code>POST {{ request.host_url }}delivery/webhook/rappi</code></li>
        <li><strong>DiDi Food:</strong> <code>POST {{ request.host_url }}delivery/webhook/didi_food</code></li>
      </ul>
    </div>
  </div>
</div>
{% endblock %}
