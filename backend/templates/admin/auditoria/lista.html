{% extends 'base.html' %}
{% block title %}Auditoría{% endblock %}
{% block content %}
<div class="container-fluid">
  <h2 class="mt-4">Historial de Auditoría</h2>

  <form class="row g-3 mb-4" method="GET">
    <div class="col-auto">
      <label class="form-label">Desde</label>
      <input type="date" name="fecha_inicio" class="form-control" value="{{ fecha_inicio }}">
    </div>
    <div class="col-auto">
      <label class="form-label">Hasta</label>
      <input type="date" name="fecha_fin" class="form-control" value="{{ fecha_fin }}">
    </div>
    <div class="col-auto">
      <label class="form-label">Acción</label>
      <select name="accion" class="form-select">
        <option value="">Todas</option>
        {% for a in acciones %}
        <option value="{{ a }}" {% if a == accion_filtro %}selected{% endif %}>{{ a }}</option>
        {% endfor %}
      </select>
    </div>
    <div class="col-auto">
      <label class="form-label">Entidad</label>
      <select name="entidad" class="form-select">
        <option value="">Todas</option>
        {% for e in entidades %}
        <option value="{{ e }}" {% if e == entidad_filtro %}selected{% endif %}>{{ e }}</option>
        {% endfor %}
      </select>
    </div>
    <div class="col-auto align-self-end">
      <button type="submit" class="btn btn-primary btn-sm">Filtrar</button>
    </div>
  </form>

  <div class="table-responsive">
    <table class="table table-striped table-sm">
      <thead>
        <tr>
          <th>Fecha/Hora</th>
          <th>Usuario</th>
          <th>Acción</th>
          <th>Entidad</th>
          <th>ID</th>
          <th>Descripción</th>
          <th>IP</th>
        </tr>
      </thead>
      <tbody>
        {% for log in logs %}
        <tr>
          <td><small>{{ log.fecha.strftime('%Y-%m-%d %H:%M:%S') }}</small></td>
          <td>{{ log.usuario.nombre if log.usuario else 'Sistema' }}</td>
          <td>
            <span class="badge {% if log.accion == 'login' %}bg-primary{% elif log.accion == 'logout' %}bg-secondary{% elif log.accion in ('crear', 'pago') %}bg-success{% elif log.accion == 'editar' %}bg-warning text-dark{% elif log.accion in ('eliminar', 'cancelar') %}bg-danger{% else %}bg-info{% endif %}">
              {{ log.accion }}
            </span>
          </td>
          <td>{{ log.entidad or '-' }}</td>
          <td>{{ log.entidad_id or '-' }}</td>
          <td><small>{{ log.descripcion or '-' }}</small></td>
          <td><small>{{ log.ip_address or '-' }}</small></td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  {% if pagination.pages > 1 %}
  <nav aria-label="Paginación auditoría">
    <ul class="pagination justify-content-center">
      {% if pagination.has_prev %}
      <li class="page-item"><a class="page-link" href="?page={{ pagination.prev_num }}&fecha_inicio={{ fecha_inicio }}&fecha_fin={{ fecha_fin }}&accion={{ accion_filtro }}&entidad={{ entidad_filtro }}">← Anterior</a></li>
      {% endif %}
      <li class="page-item disabled"><a class="page-link">Página {{ pagination.page }} de {{ pagination.pages }}</a></li>
      {% if pagination.has_next %}
      <li class="page-item"><a class="page-link" href="?page={{ pagination.next_num }}&fecha_inicio={{ fecha_inicio }}&fecha_fin={{ fecha_fin }}&accion={{ accion_filtro }}&entidad={{ entidad_filtro }}">Siguiente →</a></li>
      {% endif %}
    </ul>
  </nav>
  {% endif %}
</div>
{% endblock %}
