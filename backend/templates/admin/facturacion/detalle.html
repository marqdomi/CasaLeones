{% extends 'layouts/_layout_admin.html' %}
{% block page_title %}Factura #{{ factura.id }}{% endblock %}

{% block admin_content %}
{% from 'components/_page_header.html' import page_header %}
{% call page_header('Factura #' ~ factura.id, breadcrumb=[{'label':'Admin','url':'#'}, {'label':'Facturación','url':url_for('facturacion.lista_facturas')}]) %}
  <span class="cl-badge {% if factura.estado == 'timbrada' %}cl-badge--success{% elif factura.estado == 'error' %}cl-badge--danger{% elif factura.estado == 'cancelada' %}cl-badge--muted{% else %}cl-badge--warning{% endif %}" style="font-size:0.85rem;">
    {{ factura.estado }}
  </span>
{% endcall %}

<div class="row g-4 mb-4">
  <div class="col-md-6">
    <div class="cl-card">
      <div class="cl-card__header"><strong>Datos Generales</strong></div>
      <div class="cl-card__body">
        <table class="cl-table" style="margin-bottom:0;">
          <tr><th>UUID CFDI</th><td>{{ factura.uuid_cfdi or '—' }}</td></tr>
          <tr><th>Orden</th><td>#{{ factura.orden_id }}</td></tr>
          <tr><th>Fecha</th><td>{{ factura.fecha_creacion.strftime('%Y-%m-%d %H:%M') }}</td></tr>
          <tr><th>Subtotal</th><td>${{ '%.2f'|format(factura.subtotal) }}</td></tr>
          <tr><th>IVA</th><td>${{ '%.2f'|format(factura.iva) }}</td></tr>
          <tr><th>Total</th><td><strong>${{ '%.2f'|format(factura.total) }}</strong></td></tr>
          <tr><th>Forma de Pago</th><td>{{ factura.forma_pago or '—' }}</td></tr>
        </table>
      </div>
    </div>
  </div>
  <div class="col-md-6">
    <div class="cl-card">
      <div class="cl-card__header"><strong>Receptor</strong></div>
      <div class="cl-card__body">
        <table class="cl-table" style="margin-bottom:0;">
          <tr><th>RFC</th><td>{{ factura.rfc_receptor }}</td></tr>
          <tr><th>Razón Social</th><td>{{ factura.razon_social or '—' }}</td></tr>
          <tr><th>Uso CFDI</th><td>{{ factura.uso_cfdi or '—' }}</td></tr>
          {% if factura.cliente %}
          <tr><th>Cliente</th><td>{{ factura.cliente.nombre }}</td></tr>
          <tr><th>Régimen Fiscal</th><td>{{ factura.cliente.regimen_fiscal or '—' }}</td></tr>
          {% endif %}
        </table>
      </div>
    </div>
  </div>
</div>

{% if factura.estado == 'timbrada' %}
<div class="d-flex gap-2 flex-wrap mb-4">
  <a href="{{ url_for('facturacion.download_xml', factura_id=factura.id) }}" class="cl-btn cl-btn--outline cl-btn--sm">
    <i data-lucide="file-code" class="icon-sm"></i> Descargar XML
  </a>
  <a href="{{ url_for('facturacion.download_pdf', factura_id=factura.id) }}" class="cl-btn cl-btn--outline cl-btn--sm">
    <i data-lucide="file-text" class="icon-sm"></i> Descargar PDF
  </a>
  <form method="POST" action="{{ url_for('facturacion.reenviar', factura_id=factura.id) }}" style="display:inline;">
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
    <button class="cl-btn cl-btn--outline cl-btn--sm"><i data-lucide="mail" class="icon-sm"></i> Reenviar Email</button>
  </form>
  <a href="{{ url_for('facturacion.crear_nota_credito_view', factura_id=factura.id) }}" class="cl-btn cl-btn--outline cl-btn--sm" style="color:var(--cl-warning)">
    <i data-lucide="file-minus" class="icon-sm"></i> Nota de Crédito
  </a>
  {% if factura.metodo_pago_cfdi == 'PPD' %}
  <a href="{{ url_for('facturacion.complemento_pago', factura_id=factura.id) }}" class="cl-btn cl-btn--outline cl-btn--sm">
    <i data-lucide="receipt" class="icon-sm"></i> Complemento de Pago
  </a>
  {% endif %}
</div>
{% endif %}

{% if factura.pac_response %}
<div class="cl-card mb-4" style="border-left:3px solid var(--cl-info);">
  <div class="cl-card__body"><strong>Respuesta PAC:</strong> {{ factura.pac_response }}</div>
</div>
{% endif %}

{# Notas de crédito asociadas #}
<h6 class="fw-semibold mb-3">Notas de Crédito</h6>
{% if factura.notas_credito %}
<div class="cl-card">
  <div class="cl-card__body" style="overflow-x:auto;">
    <table class="cl-table">
      <thead>
        <tr><th>ID</th><th>UUID</th><th>Motivo</th><th>Monto</th><th>Estado</th><th>Fecha</th></tr>
      </thead>
      <tbody>
        {% for nc in factura.notas_credito %}
        <tr>
          <td>{{ nc.id }}</td>
          <td><small style="color:var(--cl-text-muted)">{{ nc.uuid_cfdi or '—' }}</small></td>
          <td>{{ nc.motivo }}</td>
          <td>${{ '%.2f'|format(nc.monto) }}</td>
          <td>
            <span class="cl-badge {% if nc.estado == 'timbrada' %}cl-badge--success{% elif nc.estado == 'error' %}cl-badge--danger{% else %}cl-badge--warning{% endif %}">
              {{ nc.estado }}
            </span>
          </td>
          <td>{{ nc.fecha_creacion.strftime('%Y-%m-%d %H:%M') }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>
{% else %}
{% from 'components/_empty_state.html' import empty_state %}
{{ empty_state('file-minus', 'No hay notas de crédito para esta factura.') }}
{% endif %}
{% endblock %}
