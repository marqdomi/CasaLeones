{% extends 'layouts/_layout_admin.html' %}
{% block page_title %}Delivery{% endblock %}
{% block head %}
{{ super() }}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4/dist/chart.umd.min.js"></script>
{% endblock %}

{% block admin_content %}
{% from 'components/_page_header.html' import page_header %}
{% from 'components/_kpi_card.html' import kpi_card %}
{% call page_header('Delivery y Canal de Venta', breadcrumb=[{'label':'Admin','url':'#'}, {'label':'Reportes','url':url_for('reportes.dashboard_reportes')}]) %}
  <a href="{{ url_for('reportes.export_delivery_csv', fecha_inicio=fecha_inicio, fecha_fin=fecha_fin) }}" class="cl-btn cl-btn--outline cl-btn--sm">
    <i data-lucide="file-spreadsheet" class="icon-sm"></i> CSV
  </a>
{% endcall %}

{# Filter #}
<form class="d-flex gap-3 align-items-end mb-4 flex-wrap" method="GET">
  <div>
    <label class="cl-form-label">Desde</label>
    <input type="date" name="fecha_inicio" class="cl-form-input" value="{{ fecha_inicio }}">
  </div>
  <div>
    <label class="cl-form-label">Hasta</label>
    <input type="date" name="fecha_fin" class="cl-form-input" value="{{ fecha_fin }}">
  </div>
  <button type="submit" class="cl-btn cl-btn--primary cl-btn--sm">
    <i data-lucide="search" class="icon-sm"></i> Filtrar
  </button>
</form>

{# KPI cards #}
{% set canal_colors = {'local':'primary','uber_eats':'success','rappi':'warning','didi_food':'info'} %}
{% set canal_icons = {'local':'store','uber_eats':'bike','rappi':'package','didi_food':'truck'} %}
<div class="row g-3 mb-4">
  {% for c in canal_data %}
  <div class="col-md-3">
    {{ kpi_card(
      title=c.canal | replace('_', ' ') | title,
      value='$' ~ '%.2f'|format(c.total_ventas),
      subtitle=c.num_ordenes ~ ' órdenes · ' ~ c.porcentaje ~ '%',
      icon=canal_icons.get(c.canal, 'shopping-bag'),
      color=canal_colors.get(c.canal, 'primary')
    ) }}
  </div>
  {% endfor %}
</div>

{# Toggle #}
<div class="d-flex justify-content-between align-items-center mb-3">
  <h6 class="fw-semibold mb-0">Ventas por Canal</h6>
  <div class="d-flex gap-2">
    <button id="btnToggleDelivery" class="cl-btn cl-btn--outline cl-btn--sm"><i data-lucide="table" class="icon-sm"></i> Ver Tabla</button>
    <button id="btnExportDelivery" class="cl-btn cl-btn--outline cl-btn--sm" title="Exportar gráfica"><i data-lucide="download" class="icon-sm"></i> PNG</button>
  </div>
</div>

{# Chart #}
<div id="chartDeliveryContainer">
  <div class="cl-card mb-4">
    <div class="cl-card__body"><div style="position:relative;height:350px;"><canvas id="chartDelivery"></canvas></div></div>
  </div>
</div>

{# Table (hidden) #}
<div id="tablaDelivery" style="display:none;">
  <div class="cl-card">
    <div class="cl-card__body" style="overflow-x:auto;">
      <table class="cl-table">
        <thead><tr><th>Canal</th><th class="text-end">Órdenes</th><th class="text-end">Ventas</th><th class="text-end">Ticket Prom.</th><th class="text-end">% del Total</th></tr></thead>
        <tbody>
          {% for c in canal_data %}
          <tr>
            <td>{{ c.canal | replace('_', ' ') | title }}</td>
            <td class="text-end">{{ c.num_ordenes }}</td>
            <td class="text-end">${{ '%.2f'|format(c.total_ventas) }}</td>
            <td class="text-end">${{ '%.2f'|format(c.ticket_promedio) }}</td>
            <td class="text-end">{{ c.porcentaje }}%</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>

{% if comision_data %}
<h6 class="fw-semibold mt-4 mb-3">Comisiones por Plataforma</h6>
<div class="cl-card">
  <div class="cl-card__body" style="overflow-x:auto;">
    <table class="cl-table">
      <thead><tr><th>Plataforma</th><th class="text-end">Órdenes</th><th class="text-end">Total Plataforma</th><th class="text-end">Comisión</th><th class="text-end">Neto</th></tr></thead>
      <tbody>
        {% for c in comision_data %}
        <tr>
          <td>{{ c.plataforma | replace('_', ' ') | title }}</td>
          <td class="text-end">{{ c.cantidad }}</td>
          <td class="text-end">${{ '%.2f'|format(c.total_plataforma) }}</td>
          <td class="text-end" style="color:var(--cl-danger)">${{ '%.2f'|format(c.comision) }}</td>
          <td class="text-end fw-bold">${{ '%.2f'|format(c.neto) }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>
{% endif %}
{% endblock %}

{% block scripts %}
{{ super() }}
<script nonce="{{ csp_nonce }}">
document.addEventListener('DOMContentLoaded', function() {
  const btnToggle = document.getElementById('btnToggleDelivery');
  const chartDiv = document.getElementById('chartDeliveryContainer');
  const tableDiv = document.getElementById('tablaDelivery');

  btnToggle.addEventListener('click', function() {
    const showTable = tableDiv.style.display === 'none';
    tableDiv.style.display = showTable ? 'block' : 'none';
    chartDiv.style.display = showTable ? 'none' : 'block';
    btnToggle.innerHTML = showTable
      ? '<i data-lucide="bar-chart-3" class="icon-sm"></i> Ver Gráfica'
      : '<i data-lucide="table" class="icon-sm"></i> Ver Tabla';
    if (typeof lucide !== 'undefined') lucide.createIcons();
  });

  const colors = ['#A6192E','#28a745','#ffc107','#17a2b8','#6f42c1'];
  const params = new URLSearchParams(window.location.search);
  fetch('/admin/reportes/api/delivery?' + params.toString())
    .then(r => r.json())
    .then(data => {
      const ctx = document.getElementById('chartDelivery').getContext('2d');
      window._deliveryChart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: data.labels.map(l => l.replace('_',' ')),
          datasets: [{
            label: 'Ventas ($)',
            data: data.totales,
            backgroundColor: colors.slice(0, data.labels.length),
          }]
        },
        options: {
          responsive: true, maintainAspectRatio: false,
          plugins: {tooltip: {callbacks: {label: ctx => `$${ctx.parsed.y.toLocaleString('es-MX',{minimumFractionDigits:2})}`}}},
          scales: {y: {beginAtZero: true, ticks: {callback: v => '$'+v.toLocaleString()}}}
        }
      });
    });

  document.getElementById('btnExportDelivery').addEventListener('click', function() {
    if (!window._deliveryChart) return;
    const link = document.createElement('a');
    link.download = 'delivery.png';
    link.href = window._deliveryChart.canvas.toDataURL('image/png');
    link.click();
  });
});
</script>
{% endblock %}
