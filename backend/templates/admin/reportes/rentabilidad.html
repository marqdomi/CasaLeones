{% extends 'base.html' %}
{% block title %}Rentabilidad por Producto{% endblock %}
{% block head %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4/dist/chart.umd.min.js"></script>
{% endblock %}
{% block content %}
<div class="container-fluid">
  <h2 class="mt-4">Rentabilidad por Producto</h2>
  <a href="{{ url_for('reportes.dashboard_reportes') }}" class="btn btn-sm btn-secondary mb-3">← Reportes</a>

  <form class="row g-3 mb-4" method="GET">
    <div class="col-auto"><label class="form-label">Desde</label><input type="date" name="fecha_inicio" class="form-control" value="{{ fecha_inicio }}"></div>
    <div class="col-auto"><label class="form-label">Hasta</label><input type="date" name="fecha_fin" class="form-control" value="{{ fecha_fin }}"></div>
    <div class="col-auto align-self-end"><button type="submit" class="btn btn-primary btn-sm">Filtrar</button></div>
    <div class="col-auto align-self-end">
      <a href="{{ url_for('reportes.export_rentabilidad_csv', fecha_inicio=fecha_inicio, fecha_fin=fecha_fin) }}" class="btn btn-outline-success btn-sm">Exportar CSV</a>
    </div>
  </form>

  <div class="d-flex justify-content-between align-items-center mb-3">
    <h5 class="mb-0">Margen y Rentabilidad</h5>
    <div>
      <button id="btnToggleRentabilidad" class="btn btn-outline-secondary btn-sm"><i class="fas fa-chart-scatter me-1"></i>Ver Gráfica</button>
      <button id="btnExportRentabilidad" class="btn btn-outline-info btn-sm ms-1" title="Exportar gráfica"><i class="fas fa-download me-1"></i>PNG</button>
    </div>
  </div>

  <!-- Chart (hidden by default) -->
  <div id="chartRentabilidadContainer" style="display:none;">
    <div class="card mb-4">
      <div class="card-body">
        <h6 class="card-title text-muted">Precio Venta vs Margen %</h6>
        <div style="position:relative;height:400px;"><canvas id="chartRentabilidad"></canvas></div>
      </div>
    </div>
  </div>

  <!-- Table -->
  <div id="tablaRentabilidad">
    <div class="table-responsive">
      <table class="table table-striped table-hover">
        <thead>
          <tr>
            <th>#</th>
            <th>Producto</th>
            <th class="text-end">Precio Venta</th>
            <th class="text-end">Costo</th>
            <th class="text-end">Margen $</th>
            <th class="text-end">Margen %</th>
            <th class="text-end">Vendidos</th>
            <th class="text-end">Utilidad Total</th>
          </tr>
        </thead>
        <tbody>
          {% for row in rows %}
          <tr{% if row.margen_pct is not none and row.margen_pct < 30 %} class="table-danger"{% endif %}>
            <td>{{ loop.index }}</td>
            <td>{{ row.nombre }}</td>
            <td class="text-end">${{ '%.2f'|format(row.precio_venta) }}</td>
            <td class="text-end">{% if row.costo is not none %}${{ '%.2f'|format(row.costo) }}{% else %}<span class="text-muted">N/A</span>{% endif %}</td>
            <td class="text-end">{% if row.margen_abs is not none %}${{ '%.2f'|format(row.margen_abs) }}{% else %}-{% endif %}</td>
            <td class="text-end">
              {% if row.margen_pct is not none %}
                <span class="badge {% if row.margen_pct >= 50 %}bg-success{% elif row.margen_pct >= 30 %}bg-warning text-dark{% else %}bg-danger{% endif %}">
                  {{ '%.1f'|format(row.margen_pct) }}%
                </span>
              {% else %}-{% endif %}
            </td>
            <td class="text-end">{{ row.cantidad }}</td>
            <td class="text-end">{% if row.utilidad_total is not none %}${{ '%.2f'|format(row.utilidad_total) }}{% else %}-{% endif %}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>
{% endblock %}
{% block scripts %}
{{ super() }}
<script nonce="{{ csp_nonce }}">
document.addEventListener('DOMContentLoaded', function() {
  const btnToggle = document.getElementById('btnToggleRentabilidad');
  const chartDiv = document.getElementById('chartRentabilidadContainer');
  const tableDiv = document.getElementById('tablaRentabilidad');
  let chartInstance = null;

  btnToggle.addEventListener('click', function() {
    const showChart = chartDiv.style.display === 'none';
    chartDiv.style.display = showChart ? 'block' : 'none';
    tableDiv.style.display = showChart ? 'none' : 'block';
    btnToggle.innerHTML = showChart
      ? '<i class="fas fa-table me-1"></i>Ver Tabla'
      : '<i class="fas fa-chart-scatter me-1"></i>Ver Gráfica';
    if (showChart && !chartInstance) loadChart();
  });

  document.getElementById('btnExportRentabilidad').addEventListener('click', function() {
    if (!chartInstance) return;
    const link = document.createElement('a');
    link.download = 'rentabilidad.png';
    link.href = chartInstance.canvas.toDataURL('image/png');
    link.click();
  });

  function loadChart() {
    const params = new URLSearchParams(window.location.search);
    fetch('/admin/reportes/api/rentabilidad?' + params.toString())
      .then(r => r.json())
      .then(data => {
        const ctx = document.getElementById('chartRentabilidad').getContext('2d');
        chartInstance = new Chart(ctx, {
          type: 'scatter',
          data: {
            datasets: [{
              label: 'Productos',
              data: data.productos.map(p => ({x: p.precio, y: p.margen, nombre: p.nombre})),
              backgroundColor: data.productos.map(p => p.margen < 30 ? 'rgba(220,53,69,0.7)' : 'rgba(40,167,69,0.7)'),
              pointRadius: 8,
              pointHoverRadius: 12,
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              tooltip: {
                callbacks: {
                  label: ctx => `${ctx.raw.nombre}: Precio $${ctx.raw.x.toFixed(2)}, Margen ${ctx.raw.y.toFixed(1)}%`
                }
              },
              annotation: {
                annotations: {
                  line30: {type:'line', yMin:30, yMax:30, borderColor:'rgba(255,193,7,0.8)', borderDash:[6,6], label:{display:true, content:'30%', position:'end'}}
                }
              }
            },
            scales: {
              x: {title: {display: true, text: 'Precio Venta ($)'}},
              y: {title: {display: true, text: 'Margen (%)'}},
            }
          }
        });
      });
  }
});
</script>
{% endblock %}
