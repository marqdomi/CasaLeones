{% extends 'layouts/_layout_admin.html' %}
{% block page_title %}Rentabilidad{% endblock %}
{% block head %}
{{ super() }}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4/dist/chart.umd.min.js"></script>
{% endblock %}

{% block admin_content %}
{% from 'components/_page_header.html' import page_header %}
{% call page_header('Rentabilidad por Producto', breadcrumb=[{'label':'Admin','url':'#'}, {'label':'Reportes','url':url_for('reportes.dashboard_reportes')}]) %}
  <a href="{{ url_for('reportes.export_rentabilidad_csv', fecha_inicio=fecha_inicio, fecha_fin=fecha_fin) }}" class="cl-btn cl-btn--outline cl-btn--sm">
    <i data-lucide="file-spreadsheet" class="icon-sm"></i> CSV
  </a>
{% endcall %}

{# Filter #}
<form class="d-flex gap-3 align-items-end mb-4 flex-wrap" method="GET">
  <div>
    <label class="cl-form-label">Desde</label>
    <input type="date" name="fecha_inicio" class="cl-form-input" value="{{ fecha_inicio }}">
  </div>
  <div>
    <label class="cl-form-label">Hasta</label>
    <input type="date" name="fecha_fin" class="cl-form-input" value="{{ fecha_fin }}">
  </div>
  <button type="submit" class="cl-btn cl-btn--primary cl-btn--sm">
    <i data-lucide="search" class="icon-sm"></i> Filtrar
  </button>
</form>

{# Toggle #}
<div class="d-flex justify-content-between align-items-center mb-3">
  <h6 class="fw-semibold mb-0">Margen y Rentabilidad</h6>
  <div class="d-flex gap-2">
    <button id="btnToggleRentabilidad" class="cl-btn cl-btn--outline cl-btn--sm"><i data-lucide="scatter-chart" class="icon-sm"></i> Ver Gráfica</button>
    <button id="btnExportRentabilidad" class="cl-btn cl-btn--outline cl-btn--sm" title="Exportar gráfica"><i data-lucide="download" class="icon-sm"></i> PNG</button>
  </div>
</div>

{# Chart (hidden by default) #}
<div id="chartRentabilidadContainer" style="display:none;">
  <div class="cl-card mb-4">
    <div class="cl-card__header"><strong>Precio Venta vs Margen %</strong></div>
    <div class="cl-card__body"><div style="position:relative;height:400px;"><canvas id="chartRentabilidad"></canvas></div></div>
  </div>
</div>

{# Table #}
<div id="tablaRentabilidad">
  <div class="cl-card">
    <div class="cl-card__body" style="overflow-x:auto;">
      <table class="cl-table">
        <thead>
          <tr>
            <th>#</th>
            <th>Producto</th>
            <th class="text-end">Precio Venta</th>
            <th class="text-end">Costo</th>
            <th class="text-end">Margen $</th>
            <th class="text-end">Margen %</th>
            <th class="text-end">Vendidos</th>
            <th class="text-end">Utilidad Total</th>
          </tr>
        </thead>
        <tbody>
          {% for row in rows %}
          <tr{% if row.margen_pct is not none and row.margen_pct < 30 %} style="background:var(--cl-danger-bg,rgba(220,53,69,.08));"{% endif %}>
            <td>{{ loop.index }}</td>
            <td>{{ row.nombre }}</td>
            <td class="text-end">${{ '%.2f'|format(row.precio_venta) }}</td>
            <td class="text-end">{% if row.costo is not none %}${{ '%.2f'|format(row.costo) }}{% else %}<span style="color:var(--cl-text-muted)">N/A</span>{% endif %}</td>
            <td class="text-end">{% if row.margen_abs is not none %}${{ '%.2f'|format(row.margen_abs) }}{% else %}-{% endif %}</td>
            <td class="text-end">
              {% if row.margen_pct is not none %}
                <span class="cl-badge {% if row.margen_pct >= 50 %}cl-badge--success{% elif row.margen_pct >= 30 %}cl-badge--warning{% else %}cl-badge--danger{% endif %}">
                  {{ '%.1f'|format(row.margen_pct) }}%
                </span>
              {% else %}-{% endif %}
            </td>
            <td class="text-end">{{ row.cantidad }}</td>
            <td class="text-end">{% if row.utilidad_total is not none %}${{ '%.2f'|format(row.utilidad_total) }}{% else %}-{% endif %}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script nonce="{{ csp_nonce }}">
document.addEventListener('DOMContentLoaded', function() {
  const btnToggle = document.getElementById('btnToggleRentabilidad');
  const chartDiv = document.getElementById('chartRentabilidadContainer');
  const tableDiv = document.getElementById('tablaRentabilidad');
  let chartInstance = null;

  btnToggle.addEventListener('click', function() {
    const showChart = chartDiv.style.display === 'none';
    chartDiv.style.display = showChart ? 'block' : 'none';
    tableDiv.style.display = showChart ? 'none' : 'block';
    btnToggle.innerHTML = showChart
      ? '<i data-lucide="table" class="icon-sm"></i> Ver Tabla'
      : '<i data-lucide="scatter-chart" class="icon-sm"></i> Ver Gráfica';
    if (typeof lucide !== 'undefined') lucide.createIcons();
    if (showChart && !chartInstance) loadChart();
  });

  document.getElementById('btnExportRentabilidad').addEventListener('click', function() {
    if (!chartInstance) return;
    const link = document.createElement('a');
    link.download = 'rentabilidad.png';
    link.href = chartInstance.canvas.toDataURL('image/png');
    link.click();
  });

  function loadChart() {
    const params = new URLSearchParams(window.location.search);
    fetch('/admin/reportes/api/rentabilidad?' + params.toString())
      .then(r => r.json())
      .then(data => {
        const ctx = document.getElementById('chartRentabilidad').getContext('2d');
        chartInstance = new Chart(ctx, {
          type: 'scatter',
          data: {
            datasets: [{
              label: 'Productos',
              data: data.productos.map(p => ({x: p.precio, y: p.margen, nombre: p.nombre})),
              backgroundColor: data.productos.map(p => p.margen < 30 ? 'rgba(220,53,69,0.7)' : 'rgba(40,167,69,0.7)'),
              pointRadius: 8,
              pointHoverRadius: 12,
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              tooltip: {
                callbacks: {
                  label: ctx => `${ctx.raw.nombre}: Precio $${ctx.raw.x.toFixed(2)}, Margen ${ctx.raw.y.toFixed(1)}%`
                }
              },
              annotation: {
                annotations: {
                  line30: {type:'line', yMin:30, yMax:30, borderColor:'rgba(255,193,7,0.8)', borderDash:[6,6], label:{display:true, content:'30%', position:'end'}}
                }
              }
            },
            scales: {
              x: {title: {display: true, text: 'Precio Venta ($)'}},
              y: {title: {display: true, text: 'Margen (%)'}},
            }
          }
        });
      });
  }
});
</script>
{% endblock %}
