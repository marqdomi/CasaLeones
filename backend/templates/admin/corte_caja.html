{% extends 'layouts/_layout_admin.html' %}
{% block page_title %}Corte de Caja{% endblock %}

{% block admin_content %}
{% from 'components/_page_header.html' import page_header %}
{% from 'components/_kpi_card.html' import kpi_card %}
{% set existing_cortes = cortes | selectattr('fecha', 'equalto', resumen.fecha) | list %}

{# ── Page header ── #}
{% call page_header('Corte de Caja', breadcrumb=[{'label':'Admin','url':url_for('admin.dashboard')},{'label':'Corte de Caja','url':'#'}]) %}
  <a href="{{ url_for('admin.export_corte_pdf') }}" class="cl-btn cl-btn--outline cl-btn--sm" style="border-color:var(--cl-danger); color:var(--cl-danger);">
    <i data-lucide="file-text" class="icon-sm"></i> Exportar PDF
  </a>
{% endcall %}

{# ── Resumen del Día ── #}
<div class="cl-card mb-4">
  <div class="cl-card__header">
    <i data-lucide="calendar" class="icon-sm me-1"></i>
    <strong>Resumen del Día — {{ resumen.fecha }}</strong>
  </div>
  <div class="cl-card__body">
    {# KPI row #}
    <div class="row g-3 mb-4">
      <div class="col-6 col-md-3">
        {{ kpi_card('Total Ingresos', '$' ~ '%.2f'|format(resumen.total_ingresos), icon='dollar-sign', color='primary') }}
      </div>
      <div class="col-6 col-md-3">
        {{ kpi_card('Órdenes', resumen.num_ordenes, icon='receipt', color='success') }}
      </div>
      <div class="col-6 col-md-3">
        {{ kpi_card('Ticket Promedio', '$' ~ '%.2f'|format(resumen.ticket_promedio), icon='ticket', color='warning') }}
      </div>
      <div class="col-6 col-md-3">
        {{ kpi_card('Propinas', '$' ~ '%.2f'|format(resumen.propinas_total), icon='coins', color='accent') }}
      </div>
    </div>

    {# Desglose por método de pago #}
    <h6 class="fw-semibold mb-3">
      <i data-lucide="credit-card" class="icon-sm me-1"></i>
      Desglose por Método de Pago
    </h6>
    <div class="row g-3 mb-4">
      <div class="col-md-4">
        <div class="cl-card" style="border-left:4px solid var(--cl-success);">
          <div class="cl-card__body text-center">
            <small class="text-muted">Efectivo esperado</small>
            <h5 class="mb-0" style="color:var(--cl-success);">${{ '%.2f'|format(resumen.efectivo_esperado) }}</h5>
          </div>
        </div>
      </div>
      <div class="col-md-4">
        <div class="cl-card" style="border-left:4px solid var(--cl-info, #0dcaf0);">
          <div class="cl-card__body text-center">
            <small class="text-muted">Tarjeta</small>
            <h5 class="mb-0" style="color:var(--cl-info, #0dcaf0);">${{ '%.2f'|format(resumen.tarjeta_total) }}</h5>
          </div>
        </div>
      </div>
      <div class="col-md-4">
        <div class="cl-card" style="border-left:4px solid var(--cl-warning);">
          <div class="cl-card__body text-center">
            <small class="text-muted">Transferencia</small>
            <h5 class="mb-0" style="color:var(--cl-warning);">${{ '%.2f'|format(resumen.transferencia_total) }}</h5>
          </div>
        </div>
      </div>
    </div>

    {# Formulario de conciliación #}
    <h6 class="fw-semibold mb-3">
      <i data-lucide="calculator" class="icon-sm me-1"></i>
      Conciliación de Efectivo
    </h6>
    <form method="POST">
      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
      <div class="row align-items-end mb-3 g-3">
        <div class="col-md-4">
          <label for="efectivo_contado" class="cl-form-label">Efectivo contado en caja ($)</label>
          <input type="number" step="0.01" min="0" name="efectivo_contado" id="efectivo_contado"
                 class="cl-form-input" placeholder="0.00" required
                 oninput="calcularDiferencia()">
        </div>
        <div class="col-md-4">
          <label class="cl-form-label">Diferencia</label>
          <input type="text" id="diferencia_display" class="cl-form-input" readonly>
        </div>
      </div>
      <div class="mb-3">
        <label for="notas" class="cl-form-label">Notas / Observaciones</label>
        <textarea name="notas" id="notas" class="cl-form-input" rows="2"
                  placeholder="Ej: Faltante por cambio no registrado..."></textarea>
      </div>
      <button type="submit" class="cl-btn cl-btn--success"
        {% if existing_cortes | length %}disabled title="Ya existe corte para hoy"{% endif %}>
        <i data-lucide="check-circle" class="icon-sm"></i> Generar Corte de Caja
      </button>
    </form>
  </div>
</div>

{# ── Historial de Cortes ── #}
<div class="cl-card">
  <div class="cl-card__header">
    <i data-lucide="history" class="icon-sm me-1"></i>
    <strong>Historial de Cortes</strong>
  </div>
  <div class="cl-card__body p-0">
    <div class="table-responsive">
      <table class="cl-table cl-table--striped cl-table--hover">
        <thead>
          <tr>
            <th>Fecha</th>
            <th>Total</th>
            <th># Órdenes</th>
            <th>Efectivo Esperado</th>
            <th>Efectivo Contado</th>
            <th>Diferencia</th>
            <th>Tarjeta</th>
            <th>Transfer.</th>
            <th>Realizado por</th>
            <th>Notas</th>
          </tr>
        </thead>
        <tbody>
          {% for c in cortes %}
          <tr>
            <td>{{ c.fecha }}</td>
            <td>${{ '%.2f'|format(c.total_ingresos) }}</td>
            <td>{{ c.num_ordenes }}</td>
            <td>${{ '%.2f'|format(c.efectivo_esperado or 0) }}</td>
            <td>${{ '%.2f'|format(c.efectivo_contado or 0) }}</td>
            <td class="{% if (c.diferencia or 0) < 0 %}text-danger fw-bold{% elif (c.diferencia or 0) > 0 %}text-success{% endif %}">
              ${{ '%.2f'|format(c.diferencia or 0) }}
            </td>
            <td>${{ '%.2f'|format(c.tarjeta_total or 0) }}</td>
            <td>${{ '%.2f'|format(c.transferencia_total or 0) }}</td>
            <td>{{ c.usuario.nombre if c.usuario else 'N/A' }}</td>
            <td>{{ c.notas or '' }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>

<script>
function calcularDiferencia() {
    const contado = parseFloat(document.getElementById('efectivo_contado').value) || 0;
    const esperado = {{ resumen.efectivo_esperado }};
    const diff = contado - esperado;
    const el = document.getElementById('diferencia_display');
    el.value = '$' + diff.toFixed(2);
    el.className = 'cl-form-input ' + (diff < 0 ? 'text-danger fw-bold' : diff > 0 ? 'text-success' : '');
}
</script>
{% endblock %}
