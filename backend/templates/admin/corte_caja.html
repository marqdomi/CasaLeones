{% extends 'base.html' %}
{% block content %}
{% set existing_cortes = cortes | selectattr('fecha', 'equalto', resumen.fecha) | list %}
<div class="container-fluid">
  <h1 class="mt-4">Corte de Caja
    <a href="{{ url_for('admin.export_corte_pdf') }}" class="btn btn-outline-danger btn-sm ms-2">
      <i class="fas fa-file-pdf me-1"></i>Exportar PDF
    </a>
  </h1>
  <ul class="nav nav-pills mb-4">
    <li class="nav-item"><a class="nav-link" href="{{ url_for('admin.lista_usuarios') }}">Usuarios</a></li>
    <li class="nav-item"><a class="nav-link" href="{{ url_for('admin.lista_productos') }}">Productos</a></li>
    <li class="nav-item"><a class="nav-link" href="{{ url_for('admin.lista_mesas') }}">Mesas</a></li>
    <li class="nav-item"><a class="nav-link active" href="{{ url_for('admin.corte_caja') }}">Corte de Caja</a></li>
  </ul>

  {# --- Resumen del día --- #}
  <div class="card mb-4">
    <div class="card-header bg-primary text-white"><h5 class="mb-0">Resumen del Día — {{ resumen.fecha }}</h5></div>
    <div class="card-body">
      <div class="row text-center mb-3">
        <div class="col-md-3">
          <h6 class="text-muted">Total Ingresos</h6>
          <h4>${{ '%.2f'|format(resumen.total_ingresos) }}</h4>
        </div>
        <div class="col-md-3">
          <h6 class="text-muted">Órdenes</h6>
          <h4>{{ resumen.num_ordenes }}</h4>
        </div>
        <div class="col-md-3">
          <h6 class="text-muted">Ticket Promedio</h6>
          <h4>${{ '%.2f'|format(resumen.ticket_promedio) }}</h4>
        </div>
        <div class="col-md-3">
          <h6 class="text-muted">Propinas</h6>
          <h4 class="text-success">${{ '%.2f'|format(resumen.propinas_total) }}</h4>
        </div>
      </div>
      <hr>
      <h6>Desglose por Método de Pago</h6>
      <div class="row mb-3">
        <div class="col-md-4">
          <div class="card border-success">
            <div class="card-body text-center">
              <small class="text-muted">Efectivo esperado</small>
              <h5 class="text-success">${{ '%.2f'|format(resumen.efectivo_esperado) }}</h5>
            </div>
          </div>
        </div>
        <div class="col-md-4">
          <div class="card border-info">
            <div class="card-body text-center">
              <small class="text-muted">Tarjeta</small>
              <h5 class="text-info">${{ '%.2f'|format(resumen.tarjeta_total) }}</h5>
            </div>
          </div>
        </div>
        <div class="col-md-4">
          <div class="card border-warning">
            <div class="card-body text-center">
              <small class="text-muted">Transferencia</small>
              <h5 class="text-warning">${{ '%.2f'|format(resumen.transferencia_total) }}</h5>
            </div>
          </div>
        </div>
      </div>
      <hr>

      {# --- Formulario conciliación --- #}
      <form method="POST">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <h6>Conciliación de Efectivo</h6>
        <div class="row align-items-end mb-3">
          <div class="col-md-4">
            <label for="efectivo_contado" class="form-label">Efectivo contado en caja ($)</label>
            <input type="number" step="0.01" min="0" name="efectivo_contado" id="efectivo_contado"
                   class="form-control" placeholder="0.00" required
                   oninput="calcularDiferencia()">
          </div>
          <div class="col-md-4">
            <label class="form-label">Diferencia</label>
            <input type="text" id="diferencia_display" class="form-control" readonly>
          </div>
        </div>
        <div class="mb-3">
          <label for="notas" class="form-label">Notas / Observaciones</label>
          <textarea name="notas" id="notas" class="form-control" rows="2"
                    placeholder="Ej: Faltante por cambio no registrado..."></textarea>
        </div>
        <button type="submit" class="btn btn-success"
          {% if existing_cortes | length %}disabled title="Ya existe corte para hoy"{% endif %}>
          Generar Corte de Caja
        </button>
      </form>
    </div>
  </div>

  {# --- Historial --- #}
  <h2>Historial de Cortes</h2>
  <div class="table-responsive">
    <table class="table table-striped table-bordered">
      <thead>
        <tr>
          <th>Fecha</th>
          <th>Total</th>
          <th># Órdenes</th>
          <th>Efectivo Esperado</th>
          <th>Efectivo Contado</th>
          <th>Diferencia</th>
          <th>Tarjeta</th>
          <th>Transfer.</th>
          <th>Realizado por</th>
          <th>Notas</th>
        </tr>
      </thead>
      <tbody>
        {% for c in cortes %}
        <tr>
          <td>{{ c.fecha }}</td>
          <td>${{ '%.2f'|format(c.total_ingresos) }}</td>
          <td>{{ c.num_ordenes }}</td>
          <td>${{ '%.2f'|format(c.efectivo_esperado or 0) }}</td>
          <td>${{ '%.2f'|format(c.efectivo_contado or 0) }}</td>
          <td class="{% if (c.diferencia or 0) < 0 %}text-danger fw-bold{% elif (c.diferencia or 0) > 0 %}text-success{% endif %}">
            ${{ '%.2f'|format(c.diferencia or 0) }}
          </td>
          <td>${{ '%.2f'|format(c.tarjeta_total or 0) }}</td>
          <td>${{ '%.2f'|format(c.transferencia_total or 0) }}</td>
          <td>{{ c.usuario.nombre if c.usuario else 'N/A' }}</td>
          <td>{{ c.notas or '' }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<script>
function calcularDiferencia() {
    const contado = parseFloat(document.getElementById('efectivo_contado').value) || 0;
    const esperado = {{ resumen.efectivo_esperado }};
    const diff = contado - esperado;
    const el = document.getElementById('diferencia_display');
    el.value = '$' + diff.toFixed(2);
    el.className = 'form-control ' + (diff < 0 ? 'text-danger fw-bold' : diff > 0 ? 'text-success' : '');
}
</script>
{% endblock %}
