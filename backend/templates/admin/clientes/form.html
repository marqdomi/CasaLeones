{% extends 'layouts/_layout_admin.html' %}
{% block page_title %}{{ 'Editar' if cliente else 'Nuevo' }} Cliente{% endblock %}

{% block admin_content %}
{% from 'components/_page_header.html' import page_header %}
{% from 'components/_form_group.html' import form_group, form_textarea %}

{{ page_header(
    'Editar Cliente: ' ~ cliente.nombre if cliente else 'Nuevo Cliente',
    breadcrumb=[('CRM', ''), ('Clientes', url_for('clientes.lista_clientes')), (('Editar' if cliente else 'Nuevo'), '')]
) }}

<div class="cl-card" style="max-width:640px;">
  <form method="POST" id="clienteForm">
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

    {{ form_group('nombre', 'Nombre', value=cliente.nombre if cliente else '', required=true, icon='user') }}
    <div class="row">
      <div class="col-md-6">
        {{ form_group('telefono', 'Teléfono', value=cliente.telefono if cliente else '', icon='phone') }}
      </div>
      <div class="col-md-6">
        {{ form_group('email', 'Email', type='email', value=cliente.email if cliente else '', icon='mail') }}
      </div>
    </div>

    <hr class="my-4">
    <h6 class="mb-3" style="color:var(--cl-text-secondary)">
      <i data-lucide="file-text" class="icon-sm"></i> Datos Fiscales
    </h6>

    <div class="row">
      <div class="col-md-6">
        <div class="cl-form-group">
          <label class="cl-form-label" for="rfc_input">RFC</label>
          <input type="text" class="cl-form-input" id="rfc_input" name="rfc" maxlength="13"
                 data-rfc-validate
                 value="{{ cliente.rfc if cliente else '' }}"
                 placeholder="Ej: XAXX010101000">
          <small class="cl-form-hint">13 chars persona física, 12 persona moral</small>
        </div>
      </div>
      <div class="col-md-6">
        <div class="cl-form-group">
          <label class="cl-form-label" for="regimen_select">Régimen Fiscal</label>
          <select class="cl-form-input cl-form-select" id="regimen_select" name="regimen_fiscal">
            <option value="">— Seleccionar —</option>
            {% for code, desc in regimenes.items() %}
            <option value="{{ code }}" {% if cliente and cliente.regimen_fiscal == code %}selected{% endif %}>
              {{ code }} — {{ desc }}
            </option>
            {% endfor %}
          </select>
        </div>
      </div>
    </div>

    <div class="row">
      <div class="col-md-6">
        <div class="cl-form-group">
          <label class="cl-form-label" for="uso_cfdi_select">Uso CFDI</label>
          <select class="cl-form-input cl-form-select" id="uso_cfdi_select" name="uso_cfdi">
            {% for code, desc in usos_cfdi.items() %}
            <option value="{{ code }}" {% if cliente and cliente.uso_cfdi == code %}selected{% endif %}>
              {{ code }} — {{ desc }}
            </option>
            {% endfor %}
          </select>
        </div>
      </div>
      <div class="col-md-6">
        {{ form_group('domicilio_fiscal', 'CP Domicilio Fiscal', value=cliente.domicilio_fiscal if cliente else '', pattern='\\d{5}', placeholder='00000') }}
      </div>
    </div>

    {{ form_group('razon_social', 'Razón Social', value=cliente.razon_social if cliente else '') }}
    {{ form_textarea('notas', 'Notas', value=cliente.notas if cliente else '', rows=2) }}

    <div class="d-flex gap-2 mt-4">
      <button type="submit" class="cl-btn cl-btn--primary">
        <i data-lucide="save" class="icon-sm"></i> Guardar
      </button>
      <a href="{{ url_for('clientes.lista_clientes') }}" class="cl-btn cl-btn--ghost">Cancelar</a>
    </div>
  </form>
</div>

<script nonce="{{ csp_nonce }}">
(function() {
  const rfcInput = document.getElementById('rfc_input');
  const regimenSelect = document.getElementById('regimen_select');
  const usoCfdiSelect = document.getElementById('uso_cfdi_select');
  if (!rfcInput) return;

  rfcInput.addEventListener('input', function() {
    const pos = this.selectionStart;
    this.value = this.value.replace(/[\s\-]/g, '').toUpperCase();
    this.setSelectionRange(pos, pos);
  });

  rfcInput.addEventListener('blur', function() {
    const rfc = this.value.trim();
    if (rfc.length < 12) return;
    fetch('{{ url_for("clientes.api_catalogos_sat") }}?rfc=' + encodeURIComponent(rfc))
      .then(r => r.json())
      .then(data => {
        updateSelect(regimenSelect, data.regimenes, '{{ cliente.regimen_fiscal if cliente else "" }}');
        updateSelect(usoCfdiSelect, data.usos_cfdi, '{{ cliente.uso_cfdi if cliente else "G03" }}');
      })
      .catch(() => {});
  });

  function updateSelect(sel, items, currentVal) {
    const prevVal = sel.value || currentVal;
    sel.innerHTML = '<option value="">— Seleccionar —</option>';
    for (const [code, desc] of Object.entries(items)) {
      const opt = document.createElement('option');
      opt.value = code;
      opt.textContent = code + ' — ' + desc;
      if (code === prevVal) opt.selected = true;
      sel.appendChild(opt);
    }
  }
})();
</script>
<script nonce="{{ csp_nonce }}" src="{{ url_for('static', filename='js/rfc-validator.js') }}"></script>
{% endblock %}
