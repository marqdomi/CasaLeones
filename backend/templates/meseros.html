{% extends "base.html" %}

{% block head %}
  <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}?v={{ config.VERSION }}">
{% endblock %}

{% block title %}Dashboard de Meseros{% endblock %}

{% block content %}
{# Debug: plantilla cargada correctamente 5 #}
<h2 class="mb-4 encabezado-principal">Dashboard de Meseros</h2>

{% if ordenes_mesero|length == 0 %}
  <div class="alert alert-info">No hay órdenes activas actualmente.</div>
{% endif %}

<div class="meseros-dashboard acciones-superiores mb-3 text-end">
  <a href="{{ url_for('meseros.crear_orden_para_llevar') }}" class="btn btn-primary">Orden Para Llevar</a>
  <a href="{{ url_for('meseros.seleccionar_mesa') }}" class="btn btn-secondary">Orden Para Mesa</a>
</div>

<!-- Tabla de Órdenes Activas -->
<div class="mt-4 contenido-principal">
  <h5>Órdenes Activas</h5>
  {% set tiene_pendientes = false %}
  {% set alert_shown = false %}
  {% for orden in ordenes_mesero %}
    {% set orden_tiene_pendiente = false %}
    {% for detalle in orden.detalles %}
      {% if detalle.estado == 'pendiente' %}
        {% set orden_tiene_pendiente = true %}
        {% set tiene_pendientes = true %}
      {% endif %}
    {% endfor %}
    {% if orden_tiene_pendiente and not alert_shown %}
      <div class="alert alert-warning">Algunas órdenes tienen productos pendientes de preparación.</div>
      {% set alert_shown = true %}
    {% endif %}
  {% endfor %}
  {% if ordenes_mesero|length == 0 %}
    <p class="text-muted">No hay órdenes activas en este momento.</p>
  {% endif %}
  {% if ordenes_mesero|length > 0 %}
  <div class="table-responsive">
    <table class="ordenes-table table table-striped table-hover table-bordered">
      <thead>
        <tr>
          <th>#</th>
          <th>Cliente / Mesa</th>
          <th>Estado</th>
          <th>Acciones</th>
        </tr>
      </thead>
      <tbody>
        {% for orden in ordenes_mesero %}
        <tr>
          <td>{{ orden.id }}</td>
          <td>
            {% if orden.es_para_llevar %}
              Para Llevar
            {% else %}
              Mesa {{ orden.mesa.numero }}
            {% endif %}
          </td>
          <td>{{ orden.estado }}</td>
          <td>
            <button class="btn btn-sm btn-ver-detalle" type="button" data-bs-toggle="collapse" data-bs-target="#orden-{{ orden.id }}" aria-expanded="false" aria-controls="orden-{{ orden.id }}">
              Ver Detalles
            </button>
          </td>
        </tr>
        <tr>
          <td colspan="4">
            <div class="collapse mt-2" id="orden-{{ orden.id }}">
              <div class="card card-body text-dark bg-light">
                <table class="table table-sm">
                  <thead>
                    <tr>
                      <th>Producto</th>
                      <th>Cantidad</th>
                      <th>Estado</th>
                      <th>Acción</th>
                    </tr>
                  </thead>
                  <tbody>
                    {% for nombre, group in orden.detalles|groupby('producto.nombre') %}
                      {% set cantidad = group|sum(attribute='cantidad') %}
                      {% set estados = group|map(attribute='estado')|list %}
                      {% set entregados = group|map(attribute='entregado')|list %}
                      {% set todos_entregados = entregados|min %}
                      <tr>
                        <td>{{ nombre }}</td>
                        <td>{{ cantidad }}</td>
                        <td id="estado-orden-{{ orden.id }}-producto-{{ group[0].producto_id }}">
                          {% if 'pendiente' in estados %}pendiente{% else %}listo{% endif %}
                        </td>
                        <td>
                          {% if 'listo' in estados and not todos_entregados %}
                            <button
                              class="btn btn-sm btn-success btn-entregar"
                              onclick="marcarEntregadoGrupo('{{ orden.id }}', '{{ group[0].producto_id }}')"
                              data-url="{{ url_for('meseros.marcar_producto_grupo_entregado',
                                                  orden_id=orden.id,
                                                  producto_id=group[0].producto_id) }}"
                            >
                              Entregar
                            </button>
                          {% elif todos_entregados %}
                            <span class="text-success">Entregado</span>
                          {% else %}
                            <span class="text-muted">Pendiente</span>
                          {% endif %}
                        </td>
                      </tr>
                    {% endfor %}
                  </tbody>
                </table>
                <div class="text-center mt-3">
                  <a href="{{ url_for('meseros.detalle_orden', orden_id=orden.id) }}" class="btn btn-primary btn-sm me-2">
                    Modificar
                  </a>
                  <button 
                    type="button" 
                    class="btn btn-warning btn-sm btn-cobrar" 
                    data-orden-id="{{ orden.id }}" 
                    onclick="mostrarCobro('{{ orden.id }}')" 
                    data-bs-toggle="modal" 
                    data-bs-target="#modalCobro">
                    Cobrar
                  </button>
                </div>
              </div>
            </div>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
  {% endif %}
</div>

<!-- Modal para mostrar el desglose del cobro -->
<div class="modal fade" id="modalCobro" tabindex="-1" aria-labelledby="modalCobroLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content modal-cobro-contenido">
      <div class="modal-header">
        <h5 class="modal-title" id="modalCobroLabel">Detalle de Cobro</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
      </div>
      <div class="modal-body" id="modalCobroBody">
        <div class="text-center py-3">
          <div class="spinner-border" role="status">
            <span class="visually-hidden">Cargando...</span>
          </div>
          <p class="mt-2">Cargando detalle de la cuenta...</p>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/meseros.js') }}?v={{ config.VERSION }}"></script>
<script src="/socket.io/socket.io.js"></script>
<script>
  document.addEventListener("DOMContentLoaded", function() {
    const socket = io();

    socket.on('connect', () => {
      console.log('Socket.IO connected');
    });

    socket.on('item_listo_notificacion', function(data) {
      // Actualizar estado de la tabla y habilitar botón de entregar
      const estadoElem = document.querySelector(
        `#estado-orden-${data.orden_id}-producto-${data.producto_id}`
      );
      if (estadoElem) {
        estadoElem.textContent = 'listo';
      }
      const btnEntregar = document.querySelector(
        `button.btn-entregar[data-url*="/entregar/${data.producto_id}"]`
      );
      if (btnEntregar) {
        btnEntregar.disabled = false;
      }

      console.log('Notificación de item listo recibida por mesero:', data);
      alert(`¡ATENCIÓN MESERO! El producto "${data.producto_nombre}" de la orden #${data.orden_id} (${data.mesa_nombre || 'Para Llevar'}) está LISTO para recoger.`);
      // Opcional: si existe función para actualizar vista, llamarla aquí.
    });
    socket.on('nueva_orden_cocina', function(data) {
      console.log('Nueva orden para mesero recibida:', data);
      window.location.reload();
    });
  });
</script>
<script>
  function mostrarCobro(ordenId) {
    fetch(`/meseros/ordenes/${ordenId}/detalles_json`, { credentials: 'same-origin' })
      .then(response => response.json())
      .then(data => {
        const detalles = data.detalles || [];
        // Verificar si hay productos pendientes de entrega
        const pendientes = detalles.some(item => item.estado !== 'listo');
        let contenido = '';
        if (pendientes) {
          contenido += `<div class="alert alert-warning">Hay productos pendientes de entrega. Por favor verifica antes de cobrar.</div>`;
        }
        contenido += `<h5>Detalle de la cuenta</h5><ul>`;
        let total = 0;
        const agrupados = {};
        detalles.forEach(item => {
          if (!agrupados[item.nombre]) {
            agrupados[item.nombre] = { cantidad: 0, precio: item.precio };
          }
          agrupados[item.nombre].cantidad += item.cantidad;
        });
        Object.entries(agrupados).forEach(([nombre, info]) => {
          const subtotal = info.cantidad * info.precio;
          total += subtotal;
          contenido += `<li>${nombre} - ${info.cantidad} x $${info.precio} = $${subtotal.toFixed(2)}</li>`;
        });
        contenido += `</ul><strong>Total: $${total.toFixed(2)}</strong>`;
        contenido += `
          <div class="mb-3">
            <label for="monto_recibido">Monto recibido:</label>
            <input type="number" step="0.01" id="monto_recibido" class="form-control">
          </div>
        `;
        const modalBody = document.getElementById('modalCobroBody');
        if (!modalBody) {
          console.error('Modal body element not found');
          return;
        }
        modalBody.innerHTML = contenido;
        const confirmBtn = document.getElementById('confirmarPagoBtn');
        confirmBtn.disabled = pendientes || detalles.length === 0;
        confirmBtn.setAttribute('data-orden-id', ordenId);
        const modal = new bootstrap.Modal(document.getElementById('modalCobro'));
        modal.show();
      });
  }

  function procesarPago(event) {
    event.preventDefault();
    const btn = event.target;
    const ordenId = btn.getAttribute('data-orden-id');
    const totalText = document.querySelector('#modalCobroBody strong').textContent;
    const total = parseFloat(totalText.replace('Total: $', ''));
    const recibido = parseFloat(document.getElementById('monto_recibido').value);
    if (isNaN(recibido) || recibido < total) {
      alert('El monto recibido es inválido o insuficiente.');
      return false;
    }
    fetch(`/meseros/ordenes/${ordenId}/cobrar`, {
      method: 'POST',
      credentials: 'same-origin',
      headers: {
        'Content-Type': 'application/json',
        'X-Requested-With': 'XMLHttpRequest'
      },
      body: JSON.stringify({ monto_recibido: recibido })
    })
    .then(async response => {
      let data;
      try {
        data = await response.json();
      } catch (e) {
        console.error('No JSON in response body', e);
      }
      if (!response.ok) {
        console.error(`Error al procesar pago (${response.status}):`, data);
        const mensaje = data?.error || `Error ${response.status}: ${response.statusText}`;
        throw new Error(mensaje);
      }
      return data;
    })
    .then(data => {
      // Ocultar el modal
      const modal = bootstrap.Modal.getInstance(document.getElementById('modalCobro'));
      modal.hide();
      alert(`Pago registrado. Cambio: $${data.cambio.toFixed(2)}`);
    })
    .catch(error => {
      console.error('Error al enviar la solicitud de pago:', error);
      alert(error.message);
    });
    return false;
  }

  document.addEventListener("DOMContentLoaded", function() {
    document.querySelectorAll('.btn-cobrar').forEach(btn => {
      btn.addEventListener('click', function() {
        const ordenId = this.getAttribute('data-orden-id');
        mostrarCobro(ordenId);
      });
    });
  });

  function marcarEntregadoGrupo(ordenId, productoId) {
    fetch(`/meseros/ordenes/${ordenId}/entregar/${productoId}`, {
      method: 'POST',
      credentials: 'same-origin',
      headers: {
        'Content-Type': 'application/json',
        'X-Requested-With': 'XMLHttpRequest'
      }
    })
    .then(r => {
      if (!r.ok) throw new Error(`Error ${r.status}`);
      return r.json();
    })
    .then(data => {
      // reload or update row
      window.location.reload();
    })
    .catch(err => {
      console.error(err);
      alert('No se pudo marcar el grupo como entregado');
    });
  }
//# Scripts de funcionalidad del dashboard de meseros #
</script>
{% endblock %}