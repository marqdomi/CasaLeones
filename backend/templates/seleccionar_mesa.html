{# ═══════════════════════════════════════════════════════
   Sprint 9 — 9.4: Seleccionar Mesa
   State-aware grid with color coding, operations layout
   ═══════════════════════════════════════════════════════ #}
{% extends 'layouts/_layout_operations.html' %}
{% set active_op_tab = 'mapa' %}
{% block page_title %}Seleccionar Mesa{% endblock %}

{% block ops_content %}
{# ── Header ── #}
<div class="d-flex flex-wrap justify-content-between align-items-center gap-3" style="margin-bottom: var(--cl-space-4);">
  <div>
    <h1 style="font-size: var(--cl-text-2xl); font-weight: var(--cl-font-bold); color: var(--cl-text-primary); margin: 0;">
      <i data-lucide="grid-3x3" class="icon-md" style="vertical-align: -3px;"></i>
      Seleccionar Mesa
    </h1>
    <p style="color: var(--cl-text-secondary); margin: var(--cl-space-1) 0 0; font-size: var(--cl-text-sm);">
      Selecciona una mesa disponible para crear una nueva orden
    </p>
  </div>
  <div class="d-flex gap-2 align-items-center">
    {# Legend #}
    <div class="d-none d-md-flex gap-3 align-items-center" style="font-size: var(--cl-text-xs); color: var(--cl-text-secondary);">
      <span><span style="display: inline-block; width: 12px; height: 12px; border-radius: 50%; background: var(--cl-success-500); margin-right: 4px; vertical-align: -1px;"></span>Disponible</span>
      <span><span style="display: inline-block; width: 12px; height: 12px; border-radius: 50%; background: var(--cl-error-500); margin-right: 4px; vertical-align: -1px;"></span>Ocupada</span>
      <span><span style="display: inline-block; width: 12px; height: 12px; border-radius: 50%; background: var(--cl-warning-500); margin-right: 4px; vertical-align: -1px;"></span>Reservada</span>
      <span><span style="display: inline-block; width: 12px; height: 12px; border-radius: 50%; background: var(--cl-gray-400); margin-right: 4px; vertical-align: -1px;"></span>Mantenimiento</span>
    </div>
    <a href="{{ url_for('meseros.view_meseros') }}" class="cl-btn cl-btn--outline cl-btn--sm">
      <i data-lucide="arrow-left" class="icon-sm"></i> Regresar
    </a>
  </div>
</div>

{# ── Zone filters ── #}
{% if zonas %}
<div class="d-flex gap-2 flex-wrap" style="margin-bottom: var(--cl-space-4);">
  <button class="cl-btn cl-btn--sm cl-btn--primary mesa-zone-filter active" data-zone="all" onclick="filterZone('all', this)">
    Todas
  </button>
  {% for zona in zonas %}
  <button class="cl-btn cl-btn--sm cl-btn--outline mesa-zone-filter" data-zone="{{ zona }}" onclick="filterZone('{{ zona }}', this)">
    {{ zona }}
  </button>
  {% endfor %}
</div>
{% endif %}

{# ── Mesa Grid ── #}
<div class="row g-3" id="mesaGrid">
  {% for m in mesas %}
  {% set active_order = mesa_order_map.get(m.id) %}
  {% set is_available = m.estado == 'disponible' and not active_order %}
  {% set is_occupied = m.estado == 'ocupada' or active_order %}
  {% set is_reserved = m.estado == 'reservada' and not active_order %}
  {% set is_maintenance = m.estado == 'mantenimiento' %}

  <div class="col-6 col-sm-4 col-md-3 col-lg-2 mesa-card-wrapper" data-zone="{{ m.zona or '' }}">
    {% if is_available %}
    {# Available — click to create order #}
    <form method="POST" action="{{ url_for('meseros.seleccionar_mesa') }}">
      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
      <input type="hidden" name="mesa_id" value="{{ m.id }}">
      <button type="submit" class="cl-mesa-tile cl-mesa-tile--available" title="Disponible — Click para crear orden">
        <div class="cl-mesa-tile__number">{{ m.numero }}</div>
        <div class="cl-mesa-tile__info">
          <i data-lucide="users" class="icon-xs"></i> {{ m.capacidad }}
        </div>
        <div class="cl-mesa-tile__status">Disponible</div>
      </button>
    </form>
    {% elif is_occupied %}
    {# Occupied — click goes to active order #}
    <a href="{% if active_order %}{{ url_for('meseros.detalle_orden', orden_id=active_order.id) }}{% else %}#{% endif %}"
       class="cl-mesa-tile cl-mesa-tile--occupied" title="Ocupada — Orden #{{ active_order.id if active_order else '?' }}">
      <div class="cl-mesa-tile__number">{{ m.numero }}</div>
      <div class="cl-mesa-tile__info">
        <i data-lucide="users" class="icon-xs"></i> {{ m.capacidad }}
      </div>
      {% if active_order %}
      <div class="cl-mesa-tile__order">
        <span class="cl-badge cl-badge--pill" style="font-size: 10px; background: rgba(255,255,255,0.2); color: white;">#{{ active_order.id }}</span>
      </div>
      {% endif %}
      <div class="cl-mesa-tile__status">Ocupada</div>
    </a>
    {% elif is_reserved %}
    {# Reserved — disabled #}
    <div class="cl-mesa-tile cl-mesa-tile--reserved" title="Reservada">
      <div class="cl-mesa-tile__number">{{ m.numero }}</div>
      <div class="cl-mesa-tile__info">
        <i data-lucide="users" class="icon-xs"></i> {{ m.capacidad }}
      </div>
      <div class="cl-mesa-tile__status">Reservada</div>
    </div>
    {% else %}
    {# Maintenance — disabled #}
    <div class="cl-mesa-tile cl-mesa-tile--maintenance" title="En mantenimiento">
      <div class="cl-mesa-tile__number">{{ m.numero }}</div>
      <div class="cl-mesa-tile__info">
        <i data-lucide="users" class="icon-xs"></i> {{ m.capacidad }}
      </div>
      <div class="cl-mesa-tile__status">Mantenimiento</div>
    </div>
    {% endif %}
  </div>
  {% endfor %}
</div>

<style>
/* Mesa tile component */
.cl-mesa-tile {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  width: 100%;
  min-height: 120px;
  border-radius: var(--cl-radius-lg);
  border: 2px solid transparent;
  padding: var(--cl-space-3);
  text-decoration: none;
  transition: transform var(--cl-transition-fast), box-shadow var(--cl-transition-fast);
  cursor: pointer;
  position: relative;
}
.cl-mesa-tile:hover {
  transform: translateY(-2px);
  box-shadow: var(--cl-shadow-lg);
}
.cl-mesa-tile__number {
  font-size: var(--cl-text-2xl);
  font-weight: var(--cl-font-bold);
  line-height: 1;
  margin-bottom: var(--cl-space-1);
}
.cl-mesa-tile__info {
  font-size: var(--cl-text-xs);
  opacity: 0.8;
  display: flex;
  align-items: center;
  gap: 4px;
  margin-bottom: var(--cl-space-1);
}
.cl-mesa-tile__status {
  font-size: 11px;
  font-weight: var(--cl-font-medium);
  opacity: 0.9;
}
.cl-mesa-tile__order {
  margin-bottom: var(--cl-space-1);
}

/* Available — green */
.cl-mesa-tile--available {
  background: var(--cl-success-50);
  border-color: var(--cl-success-500);
  color: var(--cl-success-700);
}
.cl-mesa-tile--available:hover {
  background: var(--cl-success-500);
  color: white;
}
button.cl-mesa-tile--available {
  border: 2px solid var(--cl-success-500);
}

/* Occupied — red */
.cl-mesa-tile--occupied {
  background: var(--cl-error-500);
  color: white;
}
.cl-mesa-tile--occupied:hover {
  background: var(--cl-error-700);
  color: white;
}

/* Reserved — yellow */
.cl-mesa-tile--reserved {
  background: var(--cl-warning-50);
  border-color: var(--cl-warning-500);
  color: var(--cl-warning-700);
  cursor: not-allowed;
  opacity: 0.8;
}
.cl-mesa-tile--reserved:hover { transform: none; box-shadow: none; }

/* Maintenance — gray */
.cl-mesa-tile--maintenance {
  background: var(--cl-gray-100);
  border-color: var(--cl-gray-300);
  color: var(--cl-gray-500);
  cursor: not-allowed;
  opacity: 0.6;
}
.cl-mesa-tile--maintenance:hover { transform: none; box-shadow: none; }
</style>

<script>
function filterZone(zone, btn) {
  // Update active button
  document.querySelectorAll('.mesa-zone-filter').forEach(b => {
    b.classList.remove('cl-btn--primary');
    b.classList.add('cl-btn--outline');
  });
  btn.classList.remove('cl-btn--outline');
  btn.classList.add('cl-btn--primary');

  // Filter cards
  document.querySelectorAll('.mesa-card-wrapper').forEach(card => {
    if (zone === 'all' || card.dataset.zone === zone) {
      card.style.display = '';
    } else {
      card.style.display = 'none';
    }
  });
}
</script>
{% endblock %}
