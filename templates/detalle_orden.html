<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Detalle de Orden #{{ orden.id }}</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootswatch@5.3.0/dist/cosmo/bootstrap.min.css">
</head>
<body>
<div class="container">
  <h2 class="mt-4">Detalle de Orden #{{ orden.id }}</h2>
  {% if orden.es_para_llevar %}
    <p><strong>Tipo de orden:</strong> Para llevar</p>
  {% else %}
    <p><strong>Mesa:</strong> {{ orden.mesa.numero }}</p>
  {% endif %}
  <p><strong>Estado:</strong> {{ orden.estado }}</p>
  <p><strong>Tiempo de Registro:</strong> {{ orden.tiempo_registro }}</p>
  
  {% for categoria, productos_categoria in productos_por_categoria.items() %}
    <h5>{{ categoria }}</h5>
    <div class="row mb-3">
      {% for producto in productos_categoria %}
        <div class="col-md-3 mb-2">
          <div class="card text-center">
            <div class="card-body">
              <h6 class="card-title">{{ producto.nombre }}</h6>
              <p class="card-text">${{ producto.precio }}</p>
              <div class="input-group mb-2">
                <button class="btn btn-outline-secondary btn-sm" type="button" onclick="cambiarCantidad('{{ producto.id }}', -1)">-</button>
                <input type="text" id="cantidad_{{ producto.id }}" value="0" class="form-control text-center" style="max-width: 50px;" readonly>
                <button class="btn btn-outline-secondary btn-sm" type="button" onclick="cambiarCantidad('{{ producto.id }}', 1)">+</button>
              </div>
              <button class="btn btn-primary btn-sm w-100" onclick="agregarProductoConCantidad('{{ orden.id }}', '{{ producto.id }}', '{{ producto.nombre | escape }}')">Agregar</button>
            </div>
          </div>
        </div>
      {% endfor %}
    </div>
  {% endfor %}
  
  <!-- Sección para mostrar el detalle de productos agregados -->
  <div id="detalleProductos">
    <h4>Productos en la Orden</h4>
    <div id="productosList"></div>
  </div>
  
  <form method="POST" action="{{ url_for('meseros.enviar_orden_a_cocina', orden_id=orden.id) }}">
    <button type="submit" class="btn btn-danger mt-4">Enviar a Cocina</button>
  </form>
</div>

<script>
  // Función para agregar un producto a la orden vía AJAX
  function agregarProducto(ordenId) {
    const form = document.getElementById('agregarProductoForm');
    const formData = new FormData(form);
    const producto_id = parseInt(formData.get('producto_id'));
    const cantidad = parseInt(formData.get('cantidad'));
    
    const data = {
      producto_id: producto_id,
      cantidad: cantidad
    };
    
    fetch(`/api/ordenes/${ordenId}/detalle`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(result => {
      if (result.error) {
        alert('Error: ' + result.error);
      } else {
        cargarDetalleProductos(ordenId);
      }
    })
    .catch(error => console.error('Error:', error));
  }
  
  // Función para cargar y mostrar el detalle de productos de la orden
  function cargarDetalleProductos(ordenId) {
    fetch(`/api/ordenes/${ordenId}/detalle`)
      .then(response => response.json())
      .then(data => {
        let html = '<ul class="list-group">';
        data.forEach(item => {
          html += `<li class="list-group-item">
                     ${item.cantidad} x ${item.producto_nombre}
                   </li>`;
        });
        html += '</ul>';
        document.getElementById('productosList').innerHTML = html;
      })
      .catch(error => console.error('Error al cargar detalle:', error));
  }
  
  // Al cargar la página, actualiza el detalle de productos
  document.addEventListener('DOMContentLoaded', function() {
  cargarDetalleProductos(parseInt('{{ orden.id }}'));
});

  function cambiarCantidad(productoId, delta) {
    const input = document.getElementById(`cantidad_${productoId}`);
    let cantidad = parseInt(input.value) || 0;
    cantidad = Math.max(0, cantidad + delta);
    input.value = cantidad;
  }

  function agregarProductoConCantidad(ordenId, productoId, nombre) {
    const cantidad = parseInt(document.getElementById(`cantidad_${productoId}`).value);
    if (cantidad < 1) {
      alert("Debes seleccionar al menos 1 unidad de " + nombre);
      return;
    }

    const data = {
      producto_id: productoId,
      cantidad: cantidad
    };

    fetch(`/api/ordenes/${ordenId}/detalle`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(result => {
      if (result.error) {
        alert('Error: ' + result.error);
      } else {
        cargarDetalleProductos(ordenId);
        document.getElementById(`cantidad_${productoId}`).value = 0;
      }
    })
    .catch(error => console.error('Error:', error));
  }
</script>
</body>
</html>